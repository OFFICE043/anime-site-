here!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Aniverse x StudioNova</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700;900&family=Spline+Sans:wght@400;500;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Yandex.RTB -->
  <script>
    window.yaContextCb = window.yaContextCb || []
  </script>
  <script src="https://yandex.ru/ads/system/context.js" async></script>
</head>

<body>
  <header>
    <div class="logo">
      <div class="size-4">
        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z"
            fill="currentColor"></path>
        </svg>
      </div>
      <h2>Aniverse x StudioNova</h2>

    </div>
  </header>

  <div class="content">
    <div class="layout-content">
      <div class="search-bar">
        <label class="search-box" style="width: 100%;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
            <path
              d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z">
            </path>
          </svg>
          <input id="q" type="text" placeholder="Anime Qidirish">
        </label>
      </div>

      <!-- сюда JS будет вставлять карточки -->
      <div class="anime-grid" id="grid"></div>
    </div>
  </div>

  <!-- POPUP -->
  <div id="popup" class="popup" style="display:none">
    <div class="popup-card">
      <div class="popup-poster">
        <img id="pPoster" src="" alt="poster">
      </div>
      <div class="popup-body">
        <h3 id="pTitle"></h3>
        <p id="pDesc"></p>
        <div class="popup-actions">
          <button id="downloadBtn" class="download">Yuklash</button>
          <button id="closePopup" class="cancel">Bekor Qilish</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    window.yaContextCb.push(() => {
      Ya.Context.AdvManager.render({
        "blockId": "R-A-16925873-2",

        "type": "floorAd",
        "platform": "touch"
      })
    })
  </script>
  <!-- Yandex.RTB R-A-16925873-3 -->
  <script>
    window.yaContextCb.push(() => {
      Ya.Context.AdvManager.render({
        "blockId": "R-A-16925873-3",

        "type": "floorAd",
        "platform": "desktop"
      })
    })
  </script>
  <script type="module">
    import { createClient } from "https://gjyhjqupwixmxlyktefd.supabase.co";

    // === Supabase ===
    const SUPABASE_URL = 'https://aogwtvzevqvpwofcoeee.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqeWhqcXVwd2l4bXhseWt0ZWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNDI2ODUsImV4cCI6MjA3MTcxODY4NX0.l6F0SrFpm16DSX5cXa5oL-vWevIBsITXjwMuYAel3HE';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // === Элементы ===
    const grid = document.getElementById("grid");
    const searchInput = document.getElementById("q");
    const popup = document.getElementById("popup");
    const pPoster = document.getElementById("pPoster");
    const pTitle = document.getElementById("pTitle");
    const pDesc = document.getElementById("pDesc");
    const downloadBtn = document.getElementById("downloadBtn");
    const closePopup = document.getElementById("closePopup");

    let allAnime = [];

    // === Загрузка всех аниме ===
    async function loadAnime() {
      const { data, error } = await supabase.from("anime").select("*").order("created_at", { ascending: false });

      if (error) {
        console.error("Yuklash xatosi:", error);
        grid.innerHTML = `<p style="color:red">ma'lumotlarni yuklashda xatolik</p>`;
        return;
      }

      allAnime = data;
      renderList(allAnime);
    }

    // === Открыть popup ===
    function openPopup(anime) {
      pPoster.src = anime.image_url;
      pTitle.textContent = anime.title;
      pDesc.textContent = anime.description || "Ta'rif qo'shilmagan";

      downloadBtn.onclick = () => {
        window.open(`https://t.me/AniVerseClipBot?start=${anime.code}`, "_blank");
      };

      popup.style.display = "flex";
    }

    // === Закрыть popup ===
    closePopup.addEventListener("click", () => {
      popup.style.display = "none";
    });

    // === Отрисовка карточек ===
    function renderList(list) {
      if (!list.length) {
        grid.innerHTML = `<p style="color:gray">hech narsa topilmadi</p>`;
        return;
      }

      grid.innerHTML = list.map(item => `
        <div class="anime-card" data-id="${item.id}">
          <div class="poster"><img src="${item.image_url}" alt="${item.title}"></div>
          <p class="title">${item.title}</p>
          <p class="genre">${item.genre || "Janr ko'rsatilmagan"}</p>
          <p class="rating">${item.rating || "—"}</p>
        </div>
      `).join("");

      document.querySelectorAll(".anime-card").forEach((card) => {
        card.addEventListener("click", () => {
          const id = card.getAttribute("data-id");
          const anime = allAnime.find((a) => a.id == id);
          openPopup(anime);
        });
      });
    }

    // === Поиск ===
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase().trim();
      const filtered = allAnime.filter((a) => a.title.toLowerCase().includes(q));
      renderList(filtered);
    });

    loadAnime();
  </script>
</body>

</html> 
